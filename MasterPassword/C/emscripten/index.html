<html>    
    <script src="a.out.js"></script>
    <script src="util.js"></script>
    <script>
        var hashFun = Module.cwrap('libcperciva_HMAC_SHA256_Buf','undefined',['number','number','number','number', 'number']);
        //HMAC_SHA256_Buf(key, 20, data, 8, digest);                
        
        //Arrange
        var util = new Util();    
        var key = util.convertBufferFromHex("0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b");
        var data = util.convertBufferFromHex("4869205468657265");            
        
        //Copy to emscripten space
        var keyLength = key.length
        var keyPtr = Module._malloc(keyLength);
        Module.writeArrayToMemory( key, keyPtr );
        
        var dataLength = data.length
        var dataPtr = Module._malloc(dataLength);
        Module.writeArrayToMemory( data, dataPtr );
        
        var resPtr = Module._malloc(32);
        Module._memset(resPtr,0,32);

        //Act	  
        hashFun( keyPtr, keyLength, dataPtr, dataLength, resPtr )        
        
        //Assert    	
        var res = new Uint8Array(Module.HEAPU8.buffer, resPtr, 32);

        console.log( util.convertBufferToHex(res) ); 
        console.log( "b0344c61d8db38535ca8afceaf0bf12b881dc200c9833da726e9376c2e32cff7" );
        
        //Cleanup
        Module._free(keyPtr);
        Module._free(dataPtr);
        Module._free(resPtr);
        
    </script>
    
    <script>
        var scryptFun = Module.cwrap('scrypt_wrapper','number',['number','number','number','number', 'number']);        
        //bOK = scrypt_wrapper( masterPassword, strlen(masterPassword), 
        //    masterKeySalt, masterKeySaltLength, masterKey );
        
        //Arrange
        var util = new Util();    
        
        var masterPassword = "MasterPass01"   
        var encoder = new TextEncoder("utf-8");
        var masterPasswordRaw = encoder.encode( masterPassword );  
        
        var masterKeySalt =  util.convertBufferFromHex("636f6d2e6c796e6469722e6d617374657270617373776f72640000000c757365723031c3a5c3a4c3b6");
          
        //Copy to emscripten space
        var masterPasswordLength = masterPasswordRaw.length
        var masterPasswordPtr = Module._malloc(masterPasswordLength);
        Module.writeArrayToMemory( masterPasswordRaw, masterPasswordPtr );
        
        var masterKeySaltLength = masterKeySalt.length
        var masterKeySaltPtr = Module._malloc(masterKeySaltLength);
        Module.writeArrayToMemory( masterKeySalt, masterKeySaltPtr );
        
        var resPtr = Module._malloc(64);
        Module._memset(resPtr,0,64);

        //Act	  
        bOK = scryptFun( masterPasswordPtr, masterPasswordLength, 
            masterKeySaltPtr, masterKeySaltLength, resPtr )        
        
        //Assert    	
        var res = new Uint8Array(Module.HEAPU8.buffer, resPtr, 64);

        console.log( util.convertBufferToHex(res) ); 
        console.log( "9124510a3ff74e95b5447686f717c52bd5f6b39676054472bf8ba83a72cd6972b790629de544d94d1e5f105d8c74a24910d944099cf4204dab16ac0feabb17b0" );
        
        //Cleanup
        Module._free(masterPasswordPtr);
        Module._free(masterKeySaltPtr);
        Module._free(resPtr);
        
    </script>
</html>

